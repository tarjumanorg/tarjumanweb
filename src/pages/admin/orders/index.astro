---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import type { Order } from "../../../schemas/order.schema";
import { formatDate } from "../../../utils/dateUtils"; 

let orders: Order[] = [];
let errorMessage: string | null = null;

try {
  const response = await fetch(`${Astro.url.origin}/api/admin/orders`, {
     headers: {
         'Cookie': Astro.request.headers.get('cookie') || ''
     }
  });

  if (!response.ok) {
    const errorData = await response.json().catch(() => ({ error: `HTTP error ${response.status}` }));
    throw new Error(errorData.error || `Failed to fetch orders: ${response.status}`);
  }
  orders = await response.json();

} catch (e: any) {
   console.error("Error fetching admin orders:", e);

   errorMessage = "Could not load orders. Please check server logs or try again later.";

}

---

<AdminLayout title="Manage Orders">
  {errorMessage && <p style="color: red;">Error: {errorMessage}</p>}

  {orders.length === 0 && !errorMessage ? (
    <p>No orders found.</p>
  ) : (
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Created</th>
          <th>Orderer Name</th>
          <th>Status</th>
          <th>Package</th>
          <th>User ID</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {orders.map((order) => (
          <tr>
            <td>{order.id}</td>
            <td>{formatDate(order.created_at)}</td>
            <td>{order.orderer_name}</td>
            <td>{order.status || 'N/A'}</td>
            <td>{order.package_tier || 'N/A'}</td>
            <td>{order.user_id}</td>
            <td>
              <a href={`/admin/orders/${order.id}`}>Details</a>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  )}
</AdminLayout>